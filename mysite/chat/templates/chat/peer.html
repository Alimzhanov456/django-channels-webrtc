{% extends 'main.html' %}

{% block content %}
    <!-- <button id="btn-get-answer">Get Answer SDP</button> -->

    <script type="text/javascript">
        var usernameInput = document.querySelector('#username');
        var username = null;

        var loc = window.location;

        var endPoint = '';
        var wsStart = 'ws://';

        if(loc.protocol == 'https'){
            wsStart = 'wss://';
        }

        var endPoint = wsStart + loc.host + loc.pathname;

        var webSocket = new WebSocket(endPoint);

        webSocket.onopen = function(e){
            console.log('Websocket connection opened! ', e);
            // webSocket.send(
            //     JSON.stringify(
            //         {
            //             'action': 'join',
            //         }
            //     )
            // );
        }

        webSocket.onmessage = webSocketOnMessage;

        webSocket.onclose = function(e){
            console.log('Websocket connection closed! ', e);
        }

        webSocket.onerror = function(e){
            console.log('Error in websocket connection! ', e);
        }

        var btnJoin = document.querySelector('#btn-join');
        // var btnGetAnswer = document.querySelector('#btn-get-answer');

        btnJoin.onclick = btnJoinOnClick;

        function webSocketOnMessage(event){
            var parsedData = JSON.parse(event.data);

            if(parsedData['username'] != username){
                if(parsedData[''])
                createPeerConnection(parsedData, username);
            }

            // console.log('parsed_data.type: ', parsed_data['message']['type']);

            // // return if type == offer
            // // to avoid setting wrong sdp
            // // as offer will be sent by this peer
            // if(parsed_data['message']['type'] == 'offer'){
            //     return;
            // }

            // const answer = parsed_data['message'];
            // console.log('Answer received: ', answer);

            // peer1.setRemoteDescription(answer);
        }

        function createPeerConnection(parsedData, username){
            var pc = new RTCPeerConnection();
            pc.dc = createDataChannel('channel');

            if(parsedData['message'])
        }


        const peer1 = new RTCPeerConnection();
        const dc = peer1.createDataChannel("channel");
        
        // dc.onmessage = e => console.log("Just got a message: " + e.data);
        dc.onmessage = dcOnMessage
        dc.onopen = e => console.log("Connection opened.");
        peer1.onicecandidate = e => console.log("New Ice Candidate! Reprinting SDP" + JSON.stringify(peer1.localDescription));

        peer1.createOffer().then(o => peer1.setLocalDescription(o)).then(a => console.log("Set successfully."));

        function btnJoinOnClick(event){
            username = usernameInput.value;
            webSocket.send(
                JSON.stringify(
                    {
                        'action': 'join',
                        'username': username,
                    }
                )
            );

            usernameInput.value = null;
            usernameInput.disabled = true;
        }

        var btnSendMsg = document.querySelector('#btn-send-msg');
        btnSendMsg.onclick = btnSendMsgOnClick;

        var ul = document.querySelector("#message-list");

        function btnSendMsgOnClick(){
            var messageInput = document.querySelector('#msg');
            var message = messageInput.value;
            
            var li = document.createElement("li");
            li.appendChild(document.createTextNode("Me: " + message));
            ul.appendChild(li);
            
            console.log('Sending: ', message);

            dc.send(message);
            
            messageInput.value = '';
        }

        function dcOnMessage(event){
            var message = event.data;
            
            var li = document.createElement("li");
            li.appendChild(document.createTextNode("Other: " + message));
            ul.appendChild(li);
        }

    </script>
{% endblock %}